@model ProductVm
@Html.AntiForgeryToken();
<!-- Content Header (Page header) -->
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1>Ürünler</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="#">Ürün Yönetimi</a></li>
                    <li class="breadcrumb-item active">Ürün Listesi</li>
                </ol>
            </div>
        </div>
    </div><!-- /.container-fluid -->
</section>


<!-- Main content -->
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Ürün Listesi</h3>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">

                        <button type="button" class="btn btn-success" data-toggle="modal" data-target="#modalUrunEkle">
                            Ürün Ekle
                        </button>

                        <table id="tblProducts" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Ürün No</th>
                                    <th>Ürün Adı</th>
                                    <th>Birim Fiyatı</th>
                                    <th>Stok</th>
                                    <th>Kategorisi</th>
                                    <th>Tedarikçisi</th>
                                    <th></th>
                                    <th>İşlemler</th>

                                </tr>
                            </thead>
                        @*     <tbody id="tblProductsBody"> *@
@*                                 @foreach (var item in Model.ProductList)
                                {
                                    <tr>
                                        <td>@item.ProductId</td>
                                        <td>@item.ProductName</td>
                                        <td>@item.UnitPrice</td>
                                        <td>@item.UnitsInStock</td>
                                        <td>@item.CategoryName</td>
                                        <td>@item.SupplierName</td>
                                        <td><a class="btn btn-primary btnDuzenle" pid="@item.ProductId">Düzenle</a></td>
                                        <td><a class="btn btn-danger btnSil" pid="@item.ProductId">Sil</a></td>

                                    </tr>
                                } *@
                 @*            </tbody> *@

                        </table>
                    </div>
                    <!-- /.card-body -->
                </div>
                <!-- /.card -->
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->
    </div>
    <!-- /.container-fluid -->
</section>
<!-- /.content -->
<!-- modal Urun Ekle -->
<div class="modal fade" id="modalUrunEkle">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Ürün Ekleme Paneli</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">

                    <label asp-for="ProductName" class="form-label">Ürün Adı</label>
                    <input asp-for="ProductName" type="text" class="form-control" />
                </div>
                <div class="form-group">
                    <label asp-for="UnitPrice" class="form-label">Birim Fiyatı</label>
                    <input asp-for="UnitPrice" type="text" class="form-control" />
                </div>
                <div class="form-group">
                    <label asp-for="UnitsInStock" class="form-label">Stok</label>
                    <input asp-for="UnitsInStock" type="text" class="form-control" />
                </div>
                <div class="form-group">
                    <label asp-for="CategoryId" class="form-label">Kategorisi</label>
                    @*           @Html.DropDownList("CategoryId",Model.CategoryList.Select(x=>new SelectListItem(){Text=x.CategoryName,Value=x.CategoryName.ToString()}),"Seçiniz...",new {@class="form-control"})    *@
                    @*   @Html.DropDownList("CategoryId",Model.CategoryListItem,"Seçiniz...",new {@class="form-control"}) *@
                    @*                @Html.DropDownListFor(x=>x.CategoryId,Model.CategoryList.Select(x=>new SelectListItem(){Text=x.CategoryName,Value=x.CategoryName.ToString()}),"Seçiniz...") *@
                    <select asp-for="CategoryId" asp-items="Model.CategoryListItem" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label asp-for="SupplierId" class="form-label">Tedarikçisi</label>
                    <select asp-for="SupplierId" asp-items="Model.SupplierListItem" class="form-control"></select>
                </div>



            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">Kapat</button>
                <button id="btnUrunEkle" type="button" class="btn btn-primary">Kaydet</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- ./modal -->
<!-- modal Guncelle Ekle -->
<div class="modal fade" id="modalUrunGuncelle">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Ürün Guncelleme Paneli</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">

                <input asp-for="GProductId" type="hidden" class="form-control" />
                <div class="form-group">
                    <label asp-for="GProductName" class="form-label">Ürün Adı</label>
                    <input asp-for="GProductName" type="text" class="form-control" />
                </div>
                <div class="form-group">
                    <label asp-for="GUnitPrice" class="form-label">Birim Fiyatı</label>
                    <input asp-for="GUnitPrice" type="text" class="form-control" />
                </div>
                <div class="form-group">
                    <label asp-for="GUnitsInStock" class="form-label">Stok</label>
                    <input asp-for="GUnitsInStock" type="text" class="form-control" />
                </div>
                <div class="form-group">
                    <label asp-for="GCategoryId" class="form-label">Kategorisi</label>
                    <select asp-for="GCategoryId" asp-items="Model.CategoryListItem" class="form-control"></select>
                </div>
                <div class="form-group">
                    <label asp-for="GSupplierId" class="form-label">Tedarikçisi</label>
                    <select asp-for="GSupplierId" asp-items="Model.SupplierListItem" class="form-control"></select>
                </div>



            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-default" data-dismiss="modal">Kapat</button>
                <button id="btnUrunDuzunle" type="button" class="btn btn-primary">Güncelle</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- ./modal -->
@section Styles {
    <link rel="stylesheet" href="/adminassets/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="/adminassets/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="/adminassets/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
}

@section Scripts {
    <script src="/adminassets/plugins/datatables/jquery.dataTables.min.js"></script>
    <script src="/adminassets/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
    <script src="/adminassets/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
    <script src="/adminassets/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
    <script src="/adminassets/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
    <script src="/adminassets/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
    <script src="/adminassets/plugins/jszip/jszip.min.js"></script>
    <script src="/adminassets/plugins/pdfmake/pdfmake.min.js"></script>
    <script src="/adminassets/plugins/pdfmake/vfs_fonts.js"></script>
    <script src="/adminassets/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
    <script src="/adminassets/plugins/datatables-buttons/js/buttons.print.min.js"></script>
    <script src="/adminassets/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
    <!-- Page specific script -->
    <script>
        $(function () {
            $("#tblProducts").DataTable({
                    ajax: {
                        url: '/Yonetici/Product/tblProducts',
                    },
        columns: [
            { data: 'productId' },
            { data: 'productName' },
            { data: 'unitPrice' },
            { data: 'unitsInStock' },
            { data: 'categoryName' },
            { data: 'supplierName' },
            { data: 'productId' },
            { data: 'productId' }
        
        ],
                columnDefs:[
                                        {
                    targets:1,
                    render:function(data,type,row,meta)
                    {
                    return "<b>"+data+"</b>";
                    }
                    },
                    {
                    targets:6,
                    render:function(data,type,row,meta)
                    {
                    return "<a class='btn btn-primary btnDuzenle' pid='"+data+"'>Düzenle</a>";
                    }
                    },
                    {
                         targets:7,
                    render:function(data,type,row,meta)
                    {
                    return "<a class='btn btn-danger btnSil' pid='"+data+"'>Sil</a>";
                    }
                    }
                ],

                "responsive": true,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "All"]],
                "lengthChange": true,
                "autoWidth": false,
                language: {
                    url: '/adminassets/json/datatablesturkish.json'
                },
                "buttons": ["excel", "pdf", "print"],
            }).buttons().container().appendTo('#tblProducts_wrapper .col-md-6:eq(0)');


        });


        $(function () {

            $("#btnUrunEkle").click(function ()
            {
                var token = $("[name='__RequestVerificationToken']").val();
                var product = {
                    ProductName : $("#ProductName").val(),
                    UnitPrice: $("#UnitPrice").val(),
                    UnitsInStock: $("#UnitsInStock").val(),

                    CategoryId: $("#CategoryId").val(),
                    SupplierId: $("#SupplierId").val()


                }

                $.ajax({
                    url: "/Yonetici/Product/Add",
                    dataType: "json",
                    method: "post",
                    data: { urun: product,__RequestVerificationToken:token },
                    success: function (r) {
                        if (r.result)
                        {
                   
                        //        var table = "";
                        //     for(var i =0;i<r.data.length;i++)
                        //     {

                        // table+="<tr> <td>"+r.data[i].productId+"</td> <td>"+r.data[i].productName+"</td> <td>"+r.data[i].unitPrice+"</td> <td>"+r.data[i].unitsInStock+"</td> <td>"+r.data[i].categoryName+"</td> <td>"+r.data[i].supplierName+"</td> <td><a class='btn btn-primary btnDuzenle' pid='"+r.data[i].productId+"'>Düzenle</a></td> <td><a class='btn btn-danger btnSil' pid='"+r.data[i].productId+"'>Sil</a></td> </tr>";
                        //     }
                        //      $("#tblProductsBody").html(table);


                        // window.location.reload();
                        
                        
                        var table = new DataTable('#tblProducts');
                        table.ajax.reload(null,false);
                            Swal.fire({
                            title: "Eklendi!",
                            text: "Ürün başarıyla eklendi",
                            icon: "success"
                            });
                        }
                        
                        

                    },
                    error: function () {

                    }
                });

            });

            $("#tblProducts").on("click",".btnDuzenle",function()
            {
               var pid = $(this).attr("pid");

               $.ajax({
                    url: "/Yonetici/Product/GetProduct",
                    dataType: "json",
                    method: "post",
                    data: { id: pid },
                    success: function (r) {
                        if (r.result)
                        {
                        $("#GProductId").val(r.data.productId);
                        $("#GProductName").val(r.data.productName);
                        $("#GUnitPrice").val(r.data.unitPrice);
                        $("#GUnitsInStock").val(r.data.unitsInStock);

                        $("#GCategoryId").val(r.data.categoryId);
                        $("#GSupplierId").val(r.data.supplierId);

                        $("#modalUrunGuncelle").modal("show");
                        }
                    },
                    error: function () {

                    }
                });

            });

            $("body").on("click","#btnUrunDuzunle",function()
            {
                var token = $("[name='__RequestVerificationToken']").val();
               var product = {
                    ProductId : $("#GProductId").val(),
                    ProductName : $("#GProductName").val(),
                    UnitPrice: $("#GUnitPrice").val(),
                    UnitsInStock: $("#GUnitsInStock").val(),
                    CategoryId: $("#GCategoryId").val(),
                    SupplierId: $("#GSupplierId").val()



                }

                 $.ajax({
                    url: "/Yonetici/Product/Update",
                    dataType: "json",
                    method: "post",
                    data: { product: product,__RequestVerificationToken:token },
                    success: function (r) {
                        if (r.result)
                        {
                          Swal.fire({
                          title: "İşlem Başarılı",
                          text: r.mesaj,
                          icon: "warning",
                          showCancelButton: false,
                          confirmButtonColor: "#3085d6",
                          cancelButtonColor: "#d33",
                          confirmButtonText: "Tamam"
                            }).then((result) => {
                          if (result.isConfirmed) {
                              var table = new DataTable('#tblProducts');
                                table.ajax.reload(null,false);
                          }
                        });
                        }
                       
                    },
                    error: function () {

                    }
                });


            });

             $("#tblProducts").on("click",".btnSil",function()
            {
               var token = $("[name='__RequestVerificationToken']").val();
               var pid = $(this).attr("pid");

                       Swal.fire({
          title: "UYARI",
          text: "Ürün Silinecek Emin Misiniz!",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#3085d6",
          cancelButtonColor: "#d33",
          confirmButtonText: "Sil",
          cancelButtonText: "Vazgeç"
        }).then((result) => {
          if (result.isConfirmed) {
     
               $.ajax({
                    url: "/Yonetici/Product/Delete",
                    dataType: "json",
                    method: "post",
                    data: { id: pid,__RequestVerificationToken:token },
                    success: function (r) {
                        if (r.result)
                        {
                            var table = new DataTable('#tblProducts');
                            table.ajax.reload(null,false);
                            Swal.fire({
                            title: "Silindi!",
                            text: r.mesaj,
                            icon: "success"
                            });
                        }
                    },
                    error: function () {

                    }
                });
          }
        });


            });





        });

    </script>
}